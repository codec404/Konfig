name: Auto PR Dev to Master (D2M)

on:
  push:
    branches:
      - dev

jobs:
  create-pr:
    name: Create Dev â†’ Master PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --base master --head dev --state open --json number --jq length)
          echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT

      - name: Get new commits from this push
        id: get-commits
        if: steps.check-pr.outputs.pr_exists == '0'
        run: |
          # Get commits from the push event (new commits only)
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            # Normal push - show commits since previous dev state
            NEW_COMMITS=$(git log --oneline ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"- %s (%an)")
          else
            # First push or force push - show last 5 commits
            NEW_COMMITS=$(git log --oneline -5 ${{ github.event.after }} --pretty=format:"- %s (%an)")
          fi

          # Get all commits ready for master (for context)
          ALL_COMMITS=$(git log --oneline origin/master..origin/dev --pretty=format:"- %s (%an)" | head -20)
          COMMIT_COUNT=$(git rev-list --count origin/master..origin/dev)

          # Create PR body
          cat > pr_body.md << 'PRBODY'
          ## ðŸš€ Dev â†’ Master Sync (D2M)

          This PR contains changes from the `dev` branch ready to be merged into `master`.

          ### New Commits (Just Added)

          PRBODY

          echo "$NEW_COMMITS" >> pr_body.md

          cat >> pr_body.md << 'PRBODY'

          ### All Commits Ready for Master

          PRBODY

          echo "$ALL_COMMITS" >> pr_body.md

          cat >> pr_body.md << 'PRBODY'

          ### Checklist

          - [ ] All CI checks passed
          - [ ] Code reviewed by at least one team member
          - [ ] Documentation updated (if needed)
          - [ ] No breaking changes (or properly documented)

          ### Testing

          - [ ] Tested locally
          - [ ] Integration tests pass
          - [ ] Docker containers start successfully

          ---

          **Auto-generated PR** â€¢ Merging this will deploy to production
          PRBODY

      - name: Ensure labels exist
        if: steps.check-pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create labels if they don't exist (ignore errors if they already exist)
          gh label create "auto-pr" --description "Auto-generated pull request" --color "0E8A16" || true
          gh label create "dev-to-master" --description "PR from dev to master branch" --color "1D76DB" || true
          gh label create "d2m" --description "Dev to Master sync" --color "5319E7" || true

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create PR with labels
          gh pr create \
            --title "ðŸ”„ Dev â†’ Master (D2M): $(date +'%Y-%m-%d %H:%M')" \
            --body-file pr_body.md \
            --base master \
            --head dev \
            --label "auto-pr,dev-to-master,d2m" \
            --reviewer ${{ github.actor }} || \
          # If labels fail, create PR without them
          gh pr create \
            --title "ðŸ”„ Dev â†’ Master (D2M): $(date +'%Y-%m-%d %H:%M')" \
            --body-file pr_body.md \
            --base master \
            --head dev \
            --reviewer ${{ github.actor }}

      - name: Get new commits for comment
        id: get-new-commits
        if: steps.check-pr.outputs.pr_exists != '0'
        run: |
          # Get commits from the push event
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            NEW_COMMITS=$(git log --oneline ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"- %s (%an)")
          else
            NEW_COMMITS=$(git log --oneline -5 ${{ github.event.after }} --pretty=format:"- %s (%an)")
          fi

          # Save to file for comment
          cat > comment.md << 'COMMENT'
          ðŸ”„ **New commits pushed to dev** at $(date +'%Y-%m-%d %H:%M UTC')

          COMMENT

          echo "$NEW_COMMITS" >> comment.md

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --base master --head dev --state open --json number --jq '.[0].number')
          gh pr comment $PR_NUMBER --body-file comment.md